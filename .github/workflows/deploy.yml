name: Deploy to project

on:
    push:
        branches:
            - deploy

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v2

            - name: Set up JDK 17
              uses: actions/setup-java@v2
              with:
                  distribution: "temurin"
                  java-version: "17"

            - name: Grant execute permission for gradlew
              run: chmod +x gradlew

            - name: Build with Gradle
              run: ./gradlew clean bootJar

            - name: Debug - List build files
              run: ls -lh build/libs

            - name: Deploy to EC2
              env:
                  PRIVATE_KEY: ${{ secrets.EC2_PRIVATE_KEY }}
                  HOST: ${{ secrets.EC2_HOST }}
                  USER: ${{ secrets.EC2_USER }}
              run: |
                  echo "$PRIVATE_KEY" > private_key.pem
                  chmod 600 private_key.pem
                  scp -o StrictHostKeyChecking=no -i private_key.pem build/libs/*.jar $USER@$HOST:/home/$USER/spring/backend-3rd/
                  ssh -o StrictHostKeyChecking=no -i private_key.pem $USER@$HOST << 'EOF'
                  pkill -f "java -jar"
                  cd /home/$USER/spring/backend-3rd
                  chmod +x *.jar
                  sudo systemctl restart scheduler
                  EOF

            - name: Deployment Compleate
              run: echo "Deployment finished successfully!"
