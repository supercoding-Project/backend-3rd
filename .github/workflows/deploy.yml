name: Deploy to project

on:
    push:
        branches:
            - deploy

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v2

            - name: Set up JDK 17
              uses: actions/setup-java@v2
              with:
                  distribution: "temurin"
                  java-version: "17"

            - name: Grant execute permission for gradlew
              run: chmod +x gradlew

            - name: Build with Gradle
              run: ./gradlew clean bootJar

            - name: Deploy to EC2
              env:
                  PRIVATE_KEY: ${{ secrets.EC2_PRIVATE_KEY }}
                  HOST: ${{ secrets.EC2_HOST }}
                  USER: ${{ secrets.EC2_USER }}
              run: |
                  ssh -o StrictHostKeyChecking=no -i $PRIVATE_KEY $USER@$HOST << 'EOF'
                  pkill -f "java -jar"
                  cd /home/$USER/spring/backend-3rd
                  cp /path/to/github/actions/build/libs/*.jar .
                  nohup java -jar *.jar > app.log 2>&1 &
                  EOF

            - name: Deployment Compleate
              run: echo "Deployment finished successfully!"
